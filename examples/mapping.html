<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Bowtie Mapping Example</title>

    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />

    <!-- CSS -->
    <style type="text/css">
        html {
            height: 100%;
        }

        body {
            height: 100%;
            margin: 0;
            padding: 0;
        }

        #map-canvas {
            height: 100%;
        }
    </style>

    <!-- JS -->
    <script type="text/javascript"
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCTML74DBnSbEOJSnThtpcF-F188TTd3DA&sensor=true">
    </script>
    <script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>

    <script type="text/javascript" src="/client/js/bowtie.js"></script>

    <script type="text/javascript">
        bowtie.Mapping = function (groupId, mapCanvasId) {

            this.bs = new bowtie.BowtieClient();

            this.map = new google.maps.Map(
                document.getElementById(mapCanvasId),
                {
                    zoom: 3,
                    center: new google.maps.LatLng(0, -180),
                    mapTypeId: google.maps.MapTypeId.TERRAIN
                }
            );

            this.pathData = {};
            this.markerData = {};

            this.groupId = groupId;
        }

        bowtie.Mapping.prototype = {
            start : function (interval) {
                var self = this;
                return setInterval(
                    function () {
                        self.bs.getGroup(
                            self.groupData
                        ).setCallback(
                            self.createUpdateFunc()
                        );
                    }, interval
                );
            },

            createUpdateFunc : function () {
                var self = this;
                return function (groupData) {
                    if (groupData.Error != undefined) {
                        return;
                    }

                    for (var nodeId in groupData) {
                        var nodeData = groupData[nodeId];
                        if (nodeData.Error != undefined) {
                            return;
                        }

                        var latitude = nodeData.latitude.Value;
                        var longitude = nodeData.longitude.Value;

                        if (!(nodeId in self.pathData)) {
                            self.pathData[nodeId] = new Array();
                        }

                        if (!(nodeId in self.markerData)) {
                            self.markerData[nodeId] = new google.maps.Marker(
                                {
                                    position: newPoint,
                                    map: map
                                }
                            );  
                        }                        

                        self.pathData[nodeId].push(
                            new google.maps.LatLng(
                                latitude,
                                longitude
                            )
                        );

                        // update paths
                        path = new google.maps.Polyline({
                            path: self.pathData[nodeId],
                            strokeColor: '#FF0000',
                            strokeOpacity: 1.0,
                            strokeWeight: 2
                        });
                        path.setMap(self.map);

                        // update marker
                        self.markerData[nodeId].setPosition(newPoint);

                        console.log("Running!" + running);
                        console.log("Lat:" + latitude);
                        console.log("Long:" + longitude);
                        console.log("");
                    }
                }
            }
        }

        function run() {
            var bm = new bowtie.Mapping("b", "map-canvas");
            bm.start(500);
        }

        google.maps.event.addDomListener(window, 'load', run);

    </script>
</head>
<body>
    <div id="map-canvas"></div>
</body>
</html>
